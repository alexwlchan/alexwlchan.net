<script>
  /*
   * This file has the code used for sorting the list of photos.
   */

  // This is a list of sort options we know how to handle.
  //
  // If the user doesn't specify a sort order, the first entry in this
  // list will be the default.
  const bookmarkSortOptions = [
    {
      id: 'titleAtoZ',
      label: 'title (A to Z)',
      compareFn: (a, b) => a.title > b.title ? 1 : -1,
    },
    {
      id: 'titleZtoA',
      label: 'title (Z to A)',
      compareFn: (a, b) => a.title > b.title ? -1 : 1,
    },
    {
      id: 'publicationYear',
      label: 'publication year (newest first)',
      compareFn: (a, b) => a.publicationDate - b.publicationDate,
    },
  ];

 /*
  * Sort a list of items.
  *
  * It takes the list of items and available options, and the
  * URL query parameters passed to the page.
  *
  * It returns a list with the items in sorted order, and the
  * sort order that was applied.
  */
 function sortItems({ items, sortOptions, sortOrderId }) {

   // What sort order are we using?
   //
   // Look for a matching sort option, or use the default if the sort
   // order is null/unrecognised.
   const defaultSort = sortOptions[0];
   const selectedSort =
     sortOptions.find(s => s.id === sortOrderId) || defaultSort;

   console.debug(`Selected sort: ${JSON.stringify(selectedSort)}`);

   // Now apply the sort to the list of items.
   const sortedItems = items.sort(selectedSort.compareFn);

   return { sortedItems, appliedSortOrder: selectedSort };
 }

/*
 * Create a dropdown control to choose the sort order.  When you pick
 * a different value, the page reloads with the new sort.
 */
function sortOrderDropdown({ sortOptions, appliedSortOrder }) {
  return `
    <select onchange="setSortOrder(this.value)">
      ${
        sortOptions
          .map(({ id, label }) => `
            <option value="${id}" ${id === appliedSortOrder.id ? 'selected' : ''}>
              ${label}
            </option>
          `)
          .join("")
      }
    </select>
  `;
}

function getSortOrder(params) {
  return params.get("sortOrder");
}

function setSortOrder(sortOrderId) {
  const params = new URLSearchParams(window.location.search);
  params.set("sortOrder", sortOrderId);
  window.location.search = params.toString();
}

  const bookmarks = [
    {
      url: "https://estherschindler.medium.com/the-old-family-photos-project-lessons-in-creating-family-photos-that-people-want-to-keep-ea3909129943",
      title: "Lessons in creating family photos that people want to keep, by Esther Schindler (2018)",
      tags: ['c', 'd']
    },
    {
      url: "https://www.theatlantic.com/technology/archive/2015/01/why-i-am-not-a-maker/384767/",
      title: "Why I Am Not a Maker, by Debbie Chachra (The Atlantic, 2015)",
      tags: ['a', 'b']
    },
    {
      url: "https://meyerweb.com/eric/thoughts/2014/06/10/so-many-nevers/",
      title: "So Many Nevers, by Eric Meyer (2014)",
      tags: ['a', 'b', 'c']
    }
  ];

  const bookmarkFilters = [
    {
      key: 'tag',
      label: 'tagged with',
      filterFn: (bookmark, tagName) => bookmark.tags.includes(tagName),
    },
    {
      key: 'publicationYear',
      label: 'published in',
      filterFn: (bookmark, year) => bookmark.publicationYear === year,
    },
  ];

  /*
   * Filter a list of items.
   *
   * It takes the list of items and available filters, and the
   * URL query parameters passed to the page.
   *
   * It returns a list with the items that match these filters,
   * and a list of filters that have been applied.
   */
  function filterItems({ items, filters, params }) {

    // By default, all items match, and no filters are applied.
    var matchingItems = items;
    var appliedFilters = [];

    // Go through the URL query params one by one, and look to
    // see if there's a matching filter.
    for (const [key, value] of params) {
      console.debug(`Checking query parameter ${key}`);
      const matchingFilter = filters.find(f => f.key === key);

      if (typeof matchingFilter === 'undefined') {
        continue;
      }

      // There's a matching filter!  Go ahead and filter the
      // list of items to only those that match.
      console.debug(`Detected filter ${JSON.stringify(matchingFilter)}`);

      matchingItems = matchingItems.filter(
        item => matchingFilter.filterFn(item, value)
      );

      // Construct a new query string that doesn't include
      // this filter.
      const altQuery = new URLSearchParams(params);
      altQuery.delete(key, value);
      const queryIfRemoved = altQuery.toString();

      appliedFilters.push({
        type: matchingFilter.key,
        label: matchingFilter.label,
        value,
        queryIfRemoved,
      })
    }

    return { matchingItems, appliedFilters };
  }

  function Bookmark(bookmark) {
    return `
      <li>
        <a href="${bookmark.url}">${bookmark.title}</a>
      </li>
    `;
  }

  window.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);

    const { matchingItems: matchingBookmarks, appliedFilters } =
      filterItems({
        items: bookmarks,
        filters: bookmarkFilters,
        params: params,
      });

    document.querySelector("#appliedFilters").innerHTML =
      appliedFilters
        .map(f => `<li>${f.label}: ${f.value} <a href="?${f.queryIfRemoved}">(remove)</a></li>`)
        .join("");

    const { sortedItems: sortedBookmarks, appliedSortOrder } =
      sortItems({
        items: matchingBookmarks,
        sortOptions: bookmarkSortOptions,
        sortOrderId: getSortOrder(params),
      });

    document.querySelector("#sortOrder").innerHTML +=
      sortOrderDropdown({ sortOptions: bookmarkSortOptions, appliedSortOrder });

    document.querySelector("#listOfBookmarks").innerHTML =
      sortedBookmarks.map(Bookmark).join("");
  });
</script>

<h1>Bookmarks</h1>

<p>Applied filters:</p>

<ul id="appliedFilters"></ul>

<p id="sortOrder">Sort by:</p>

<p>Bookmarks:</p>

<ul id="listOfBookmarks"></ul>