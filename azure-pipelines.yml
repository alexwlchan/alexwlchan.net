trigger:
- "live"

pr:
- "live"

pool:
  vmImage: "ubuntu-latest"

steps:
- checkout: "self"
  fetchDepth: 1
  clean: true

- script: "make build-drafts"
  displayName: "Build the site"

- script: "make html-lint"
  displayName: "Run HTML linting"

- script: |
    chmod 600 "$DOWNLOADSECUREFILE_SECUREFILEPATH"
    git config core.sshCommand "ssh -i $DOWNLOADSECUREFILE_SECUREFILEPATH -F /dev/null"
    mkdir -p ~/.ssh
    ssh-keyscan -H github.com >> ~/.ssh/known_hosts
    git config user.name "Azure Pipelines on behalf of Alex Chan"
    git config user.email "azurepipelines_git@alexwlchan.net"
    touch ~/.gitconfig
  displayName: "Prepare Git config"
  condition: "and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/live'))"

- task: DownloadSecureFile@1
  inputs:
    secureFile: id_rsa
  condition: "and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/live'))"
  displayName: "Download SSH key"

- script: |
    # Azure Pipelines gets a fresh checkout of the repo, so it won't have
    # a _drafts folder if there's nothing checked in.  It takes ~10s in Azure
    # to publish drafts and build the site, and if there are no drafts this
    # is wasting time.  Skip!
    if [[ -d "src/_drafts" ]]
    then
      make publish-drafts
      make build
    else
      echo "There is no _drafts folder, so nothing to publish!"
    fi
  condition: "and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/live'))"
  displayName: "Publish pending drafts"
  env:
    NETLIFY_AUTH_TOKEN: $(NetlifyToken)

- script: make deploy-prod
  condition: "and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/live'))"
  displayName: "Deploy to Netlify"
  env:
    NETLIFY_AUTH_TOKEN: $(NetlifyToken)

- script: |
    git remote add ssh-origin git@github.com:alexwlchan/alexwlchan.net.git
    git push --verbose ssh-origin HEAD:live
  condition: "and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/live'))"
  displayName: "Push to GitHub"
