trigger:
- "live"

pr:
- "live"

pool:
  vmImage: "ubuntu-latest"

steps:

- checkout: self

  # Only fetch a single commit; my build doesn't do anything with
  # the commit history.
  # See https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?viewFallbackFrom=vsts&tabs=schema%2Cparameter-schema&view=azure-devops#checkout
  fetchDepth: 1

- script: "make build-drafts"
  displayName: "Build the site"

- script: "make lint"
  displayName: "Run linting"

- task: DownloadSecureFile@1
  inputs:
    secureFile: id_rsa
  condition: "eq(variables['Build.SourceBranch'], 'refs/heads/live')"
  displayName: "Download SSH key"

- script: ./scripts/deploy.sh
  condition: "eq(variables['Build.SourceBranch'], 'refs/heads/live')"
  displayName: "Deploy to Linode and push new commits to GitHub"
