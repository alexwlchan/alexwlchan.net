trigger:
- "live"

pr:
- "live"

pool:
  vmImage: "ubuntu-latest"

steps:
- checkout: "self"
  fetchDepth: 1
  clean: true

# - script: "make build-drafts"
#   displayName: "Build the site"
#
# - script: "make lint"
#   displayName: "Run linting"

- displayName: "Prepare Git config"
  condition: "eq(variables['Build.SourceBranch'], 'refs/heads/live')"
  script: |
    chmod 600 "$DOWNLOADSECUREFILE_SECUREFILEPATH"
    git config core.sshCommand "ssh -i $DOWNLOADSECUREFILE_SECUREFILEPATH -F /dev/null"

    ssh-keyscan -H github.com >> ~/.ssh/known_hosts

    git config user.name "Azure Pipelines on behalf of Alex Chan"
    git config user.email "azurepipelines_git@alexwlchan.net"

# - script: "make deploy"
#   displayName: "Deploy to Netlify"
#   condition: "ne(variables['Build.SourceBranch'], 'refs/heads/live')"
#   env:
#     NETLIFY_AUTH_TOKEN: $(NetlifyToken)

- task: DownloadSecureFile@1
  inputs:
    secureFile: id_rsa
  condition: "eq(variables['Build.SourceBranch'], 'refs/heads/live')"
  displayName: "Download SSH key"

- script: make publish-drafts
  condition: "eq(variables['Build.SourceBranch'], 'refs/heads/live')"
  displayName: "Publish any pending drafts"
  env:
    NETLIFY_AUTH_TOKEN: $(NetlifyToken)

- script: ./scripts/deploy_prod.sh
  condition: "eq(variables['Build.SourceBranch'], 'refs/heads/live')"
  displayName: "Deploy to Netlify and push new commits to GitHub"
  env:
    NETLIFY_AUTH_TOKEN: $(NetlifyToken)
